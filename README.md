# grocery-optimizer
# Grocery Optimizer PoC - Project Guide

## Project Overview

**Goal:** Build a proof-of-concept application that fetches real-time grocery deals for a given postal code and uses AI to generate optimized meal plans and shopping lists that minimize cost while meeting user dietary requirements.

**Duration:** 10-day development sprint (Sep 10-19, 2025)

**Development Environment:** GitHub Codespaces with cloud-native services

## Core Architecture

### System Design
```
User Input (postal code, budget, preferences)
    ↓
Flipp API (fetch current deals)
    ↓
PostgreSQL + TimescaleDB (store prices with history)
    ↓
Orchestrator Agent (analyze deals, group ingredients)
    ↓
Chef Agents (parallel recipe generation)
    ↓
Shopping Optimizer (consolidate list, calculate costs)
    ↓
User Output (meal plan, shopping list, savings report)
```

### Tech Stack

**Cloud Services:**
- **Database:** Neon.tech PostgreSQL with TimescaleDB extension
- **Cache:** Upstash Redis (serverless)
- **Development:** GitHub Codespaces
- **Monitoring:** Prometheus (container) + Grafana Cloud free tier

**Core Technologies:**
- **Language:** Python 3.11
- **Framework:** FastAPI
- **Background Jobs:** Celery with Upstash Redis
- **AI Models:** Hugging Face Inference API
  - Orchestrator: SmolLM-1.7B
  - Chef Agents: SmolLM-360M
  - Shopping Optimizer: SmolLM-135M

## Database Schema

### Core Tables

```sql
-- Users table
users (
    user_id SERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE,
    postal_code VARCHAR(10),
    budget DECIMAL(10,2),
    household_size INTEGER,
    dietary_restrictions JSONB,
    created_at TIMESTAMP
)

-- Stores table
stores (
    store_id SERIAL PRIMARY KEY,
    name VARCHAR(255),
    chain VARCHAR(100),
    postal_code VARCHAR(10),
    address TEXT,
    last_updated TIMESTAMP
)

-- Price snapshots (TimescaleDB hypertable)
price_snapshots (
    time TIMESTAMPTZ NOT NULL,
    store_id INTEGER REFERENCES stores,
    product_name VARCHAR(255),
    brand VARCHAR(100),
    price DECIMAL(10,2),
    sale_price DECIMAL(10,2),
    unit VARCHAR(50),
    category VARCHAR(100)
) 
-- Convert to hypertable: SELECT create_hypertable('price_snapshots', 'time');

-- Current deals (denormalized for quick access)
deals (
    deal_id SERIAL PRIMARY KEY,
    store_id INTEGER REFERENCES stores,
    product_name VARCHAR(255),
    sale_price DECIMAL(10,2),
    regular_price DECIMAL(10,2),
    discount_percentage INTEGER,
    valid_from DATE,
    valid_until DATE,
    created_at TIMESTAMP
)

-- Generated recipes
recipes (
    recipe_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users,
    name VARCHAR(255),
    ingredients JSONB,
    instructions TEXT[],
    total_cost DECIMAL(10,2),
    servings INTEGER,
    created_at TIMESTAMP
)

-- Shopping lists
shopping_lists (
    list_id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users,
    recipe_ids INTEGER[],
    items JSONB,
    total_cost DECIMAL(10,2),
    estimated_savings DECIMAL(10,2),
    created_at TIMESTAMP
)

-- API usage tracking
api_usage (
    usage_id SERIAL PRIMARY KEY,
    user_id INTEGER,
    model_name VARCHAR(100),
    tokens_used INTEGER,
    estimated_cost DECIMAL(10,4),
    endpoint VARCHAR(255),
    created_at TIMESTAMP
)
```

## Agent Architecture

### Orchestrator Agent (SmolLM-1.7B)
**Role:** Analyzes available deals and intelligently distributes work
- Fetches all deals for user's postal code
- Groups ingredients by compatibility
- Assigns ingredient sets to Chef agents
- Manages parallel recipe generation
- Consolidates results into meal plan

### Chef Agents (SmolLM-360M)
**Role:** Generate recipes from assigned ingredients
- Receive ingredient combinations from Orchestrator
- Generate recipes optimized for those ingredients
- Not specialized by meal type (any chef can make any meal)
- Return recipes with cost calculations

### Nutritionist Agent (SmolLM-360M)
**Role:** Acts as judge for recipe quality and nutritional balance
- Reviews all recipes generated by Chef agents
- Validates nutritional completeness (proteins, carbs, fats, vitamins)
- Ensures dietary restrictions are met
- Scores recipes on health criteria
- Can request Chef agents to modify recipes that fail requirements
- Provides final approval before meal plan is sent to user

### Shopping Optimizer (SmolLM-135M)
**Role:** Create efficient shopping list
- Consolidates ingredients across all recipes
- Calculates quantities needed
- Assigns items to specific stores based on best prices
- Calculates total cost and savings

## API Endpoints

### Core Endpoints
```python
POST /api/v1/users/register
    Body: {email, postal_code, budget, household_size, dietary_restrictions}
    Returns: {user_id, token}

POST /api/v1/postal-code/discover
    Body: {postal_code}
    Returns: {stores_found, deals_count, job_id}

POST /api/v1/recipes/generate
    Body: {user_id, num_meals, preferences}
    Returns: {recipes, total_cost, estimated_savings}

GET /api/v1/shopping-list/{user_id}
    Returns: {items, stores, total_cost, savings}

GET /api/v1/metrics/usage/{user_id}
    Returns: {api_calls, tokens_used, total_cost, by_model}
```

## Data Collection Strategy

### Primary: Flipp API
- Covers 100+ Canadian grocery chains
- Legitimate access through partnerships
- Rate limit: 0.5 second delay between requests
- Cache results for 6 hours

### Data Refresh Schedule
- High-traffic postal codes: Every 6 hours
- Medium-traffic: Daily
- Low-traffic: Every 3 days
- Price history retention: 90 days

## Cost Management

### HF API Optimization
- **Aggressive Caching:** 24-hour TTL for recipes, 6-hour for deals
- **Model Selection:** Use smallest viable model for each task
- **Batching:** Group similar requests when possible
- **Cost Tracking:** Log every API call with token count and cost

### Target Metrics
- API cost per user: <$0.10/month
- Recipe generation time: <2 seconds
- Cache hit rate: >70%
- Shopping list savings: 15-25% vs regular prices

## Development Priorities

### MVP Features (Must Have)
1. User registration with postal code
2. Fetch current deals via Flipp API
3. Generate 7-day meal plan using AI
4. Create optimized shopping list
5. Track API usage and costs
6. Store 30 days of price history

### Defer to Post-PoC
- Mobile app
- Social features
- Complex dietary preferences
- Multi-store route optimization
- Advanced analytics
- Email notifications

## Key Design Decisions

1. **Cloud-Native:** All services in cloud for device independence
2. **Simple Agent Model:** Orchestrator + workers, not specialized agents
3. **Price History:** TimescaleDB for efficient time-series queries
4. **Cost First:** Every feature considers API costs
5. **Data Quality:** Better to show "no data" than wrong data
6. **Legal Compliance:** Only use legitimate APIs (Flipp), no scraping

## Success Criteria

- [ ] Fetch real deals for 3+ postal codes
- [ ] Generate meal plans in <2 seconds
- [ ] Show 15%+ savings vs regular prices
- [ ] Track costs to <$0.01 accuracy
- [ ] 50+ postal codes tested successfully
- [ ] Clean architecture ready for scaling

## Daily Development Reference

When starting each session:
1. Check the development schedule (separate HTML file)
2. Review this guide for architecture decisions
3. Focus on that day's specific tasks
4. Update progress in GitHub issues
5. Test with real postal codes: M5V3A8 (Toronto), H2X1Y4 (Montreal), V6B1A1 (Vancouver)

## Environment Setup Checklist

- [ ] Neon.tech account created
- [ ] TimescaleDB extension enabled
- [ ] Upstash Redis configured
- [ ] GitHub Codespace secrets set
- [ ] HuggingFace API key obtained
- [ ] Flipp API endpoints identified
- [ ] Test postal codes ready

## Repository Structure
```
grocery-optimizer/
├── .devcontainer/
│   └── devcontainer.json      # Codespace configuration
├── app/
│   ├── main.py                # FastAPI application
│   ├── models/                # Pydantic models
│   ├── routes/                # API endpoints
│   ├── agents/                # AI agent logic
│   ├── services/              # Business logic
│   └── db/                    # Database queries
├── workers/
│   ├── celery_app.py          # Celery configuration
│   └── tasks/                 # Background tasks
├── scripts/
│   ├── init_db.sql            # Database initialization
│   └── test_agents.py         # Agent testing
├── requirements.txt           # Python dependencies
├── .env.example              # Environment template
└── README.md                 # Setup instructions
```

---

*Last Updated: September 9, 2025*
*Version: 1.0 - PoC Development Guide*